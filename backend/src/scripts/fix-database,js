import pool from '../config/database.js';
import dotenv from 'dotenv';

dotenv.config();

const fixDatabase = async () => {
  console.log('\nğŸ”§ CORRIGINDO BANCO DE DADOS\n');

  try {
    // Verificar se a coluna company_id existe
    const checkColumn = await pool.query(`
      SELECT column_name 
      FROM information_schema.columns 
      WHERE table_name = 'works' AND column_name = 'company_id';
    `);

    if (checkColumn.rows.length === 0) {
      console.log('âŒ Coluna company_id nÃ£o existe na tabela works');
      console.log('ğŸ”§ Adicionando coluna company_id...\n');

      // Verificar se existe alguma obra
      const worksCount = await pool.query('SELECT COUNT(*) FROM works');
      const hasWorks = parseInt(worksCount.rows[0].count) > 0;

      if (hasWorks) {
        console.log('âš ï¸ ATENÃ‡ÃƒO: Existem obras cadastradas!');
        console.log('âš ï¸ Vou criar uma empresa padrÃ£o e associar as obras a ela.\n');

        // Criar empresa padrÃ£o se nÃ£o existir
        const companyResult = await pool.query(`
          INSERT INTO companies (name, cnpj, address, phone, email)
          VALUES ('Model Engenharia', '12.345.678/0001-90', 'Rua Exemplo, 123', '(11) 98765-4321', 'contato@model.com.br')
          ON CONFLICT (cnpj) DO UPDATE SET name = EXCLUDED.name
          RETURNING id;
        `);

        const defaultCompanyId = companyResult.rows[0].id;
        console.log(`âœ… Empresa padrÃ£o criada/encontrada (ID: ${defaultCompanyId})`);

        // Adicionar coluna com valor padrÃ£o
        await pool.query(`
          ALTER TABLE works 
          ADD COLUMN company_id INTEGER DEFAULT ${defaultCompanyId} REFERENCES companies(id) ON DELETE CASCADE;
        `);

        console.log('âœ… Coluna company_id adicionada com empresa padrÃ£o');

        // Remover o default depois de adicionar
        await pool.query(`
          ALTER TABLE works ALTER COLUMN company_id DROP DEFAULT;
        `);

        // Tornar NOT NULL
        await pool.query(`
          ALTER TABLE works ALTER COLUMN company_id SET NOT NULL;
        `);

        console.log('âœ… Coluna company_id configurada como NOT NULL');
      } else {
        // NÃ£o hÃ¡ obras, pode adicionar diretamente
        await pool.query(`
          ALTER TABLE works 
          ADD COLUMN company_id INTEGER NOT NULL REFERENCES companies(id) ON DELETE CASCADE;
        `);
        console.log('âœ… Coluna company_id adicionada');
      }

      // Criar Ã­ndice
      await pool.query(`
        CREATE INDEX IF NOT EXISTS idx_works_company_id ON works(company_id);
      `);
      console.log('âœ… Ãndice criado');

    } else {
      console.log('âœ… Coluna company_id jÃ¡ existe!');
    }

    // Verificar estrutura final
    console.log('\nğŸ“Š Verificando estrutura da tabela works:\n');
    const columns = await pool.query(`
      SELECT 
        column_name, 
        data_type, 
        is_nullable,
        column_default
      FROM information_schema.columns 
      WHERE table_name = 'works'
      ORDER BY ordinal_position;
    `);

    columns.rows.forEach(col => {
      console.log(`   ${col.column_name.padEnd(20)} | ${col.data_type.padEnd(20)} | NULL: ${col.is_nullable}`);
    });

    console.log('\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
    console.log('â•‘  âœ… Banco de dados corrigido!             â•‘');
    console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');

    console.log('ğŸ“‹ PrÃ³ximos passos:');
    console.log('   1. Execute: npm start');
    console.log('   2. Teste: http://localhost:3001/api/works\n');

  } catch (error) {
    console.error('âŒ Erro ao corrigir banco de dados:', error.message);
    console.error('\nğŸ’¡ SoluÃ§Ã£o alternativa:');
    console.error('   1. Apague todas as tabelas');
    console.error('   2. Execute: npm run setup\n');
    throw error;
  } finally {
    await pool.end();
  }
};

// Executar correÃ§Ã£o
fixDatabase().catch((err) => {
  console.error('âŒ Falha na correÃ§Ã£o:', err.message);
  process.exit(1);
});
